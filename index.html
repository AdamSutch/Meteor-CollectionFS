<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>CollectionFS by raix</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/raix/Meteor-CollectionFS">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/raix/Meteor-CollectionFS/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/raix/Meteor-CollectionFS/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>CollectionFS</h1>
          <p>Meteor filesystem based on gridFS, Meteor.collections and filehandlers</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/raix">raix</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></span>
        </div>

        <h1>CollectionFS</h1>

<p>Is a simple way of handling files on the web in the Meteor environment</p>

<p>Have a look at <a href="http://collectionfs.meteor.com/">Live example</a></p>

<p>It's work in progress, I'll take pull requests, feature requests and feedback for optimizing stability and speed</p>

<p>CollectionFS is a mix of both Meteor.Collection and GridFS mongoDB.
Using Meteor and gridFS principles we get:</p>

<ul>
<li>Security handling</li>
<li>Handling sharing</li>
<li>Restrictions eg. only allow certain content types, fields, users etc.</li>
<li>Reactive data, the collectionFS's methods should all be reactive</li>
<li>Ability for the user to resume upload after connection loss, browser crash or cola in keyboard</li>
<li>At the moment files are loaded into the client as Blob universal way of handling large binary data</li>
<li>Create multiple cached versions, sizes or formats of your files and get an url to the file - or upload files to another service / server</li>
</ul><p>Design overview:</p>

<div class="highlight"><pre>        <span class="nx">App</span>               <span class="o">&lt;-|</span> <span class="nx">Can</span> <span class="nx">retrieve</span> <span class="nx">files</span> <span class="nx">via</span> <span class="nx">DDP</span> <span class="nx">and</span> <span class="nx">HTTP</span>
<span class="o">--------&gt;|</span>
<span class="o">|</span>      <span class="nx">__</span><span class="o">|</span><span class="nx">________</span>        <span class="o">&lt;-|</span> <span class="nx">Adds</span> <span class="nx">a</span> <span class="nx">connection</span> <span class="k">for</span> <span class="nx">each</span> <span class="nx">CollectionFS</span>
<span class="o">|</span>      <span class="o">|</span>     <span class="o">|</span> <span class="o">|</span> <span class="o">|</span>
<span class="o">*******************</span>       <span class="o">&lt;-|</span> <span class="nx">Internet</span> 
<span class="o">|</span>      <span class="o">|</span>     <span class="o">|</span> <span class="o">|</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">|</span>     <span class="o">|</span> <span class="o">|</span> <span class="o">|---</span> <span class="mi">1</span><span class="p">.</span>  <span class="o">&lt;-|</span> <span class="nx">DDP</span> <span class="nx">Connections</span> <span class="nx">dedicated</span> <span class="nx">CollectionFS</span>
<span class="o">|</span>   <span class="nx">Meteor</span>   <span class="o">|</span> <span class="o">|-----</span> <span class="mi">2</span><span class="p">.</span>  <span class="o">&lt;-|</span> <span class="k">for</span> <span class="nx">up</span><span class="o">/</span><span class="nx">downloading</span> <span class="nx">chunks</span> <span class="o">/</span> <span class="nx">binary</span> <span class="nx">data</span>
<span class="o">|</span>   <span class="p">(</span><span class="nx">DDP</span><span class="p">)</span>    <span class="err">#</span>              <span class="o">|</span> <span class="nx">Using</span> <span class="nx">EJSON</span> <span class="k">for</span> <span class="nx">transport</span> <span class="nx">wrapper</span> <span class="nx">of</span>
<span class="o">|</span>      <span class="o">|</span>     <span class="o">|-------</span> <span class="nx">n</span><span class="p">.</span>  <span class="o">&lt;-|</span> <span class="nx">$binary</span> <span class="nx">data</span>
<span class="o">|</span>      <span class="o">|</span>     <span class="err">#####</span>
<span class="o">|</span>      <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span>      <span class="nx">Mongodb</span><span class="o">-|&lt;-</span> <span class="nx">Server</span> <span class="o">&lt;-|</span> <span class="nx">TODO</span><span class="o">:</span> <span class="o">*</span><span class="nx">Server</span> <span class="nx">can</span> <span class="nx">add</span> <span class="nx">files</span> <span class="nx">pr</span><span class="p">.</span> <span class="nx">auto</span>
<span class="o">|</span>      <span class="p">(</span><span class="nx">gridFS</span><span class="p">)</span>             <span class="o">|</span> <span class="nx">or</span> <span class="nx">on</span> <span class="nx">request</span> <span class="nx">from</span> <span class="nx">client</span><span class="o">*</span>
<span class="o">|</span>          <span class="o">|</span>
<span class="o">|</span>          <span class="o">|</span><span class="nx">_______</span><span class="err">##</span>     <span class="o">&lt;-|</span> <span class="nx">Filehandlers</span> <span class="nx">running</span> <span class="nx">autonom</span> <span class="nx">scanning</span>
<span class="o">|</span>                   <span class="o">|</span>       <span class="o">|</span> <span class="k">new</span> <span class="nx">files</span> <span class="nx">to</span> <span class="nx">handle</span><span class="p">,</span> <span class="k">new</span> <span class="nx">filehandlers</span><span class="p">,</span>
<span class="o">|</span>                   <span class="o">|</span>       <span class="o">|</span> <span class="nx">retries</span> <span class="nx">failed</span> <span class="nx">ones</span> <span class="o">*</span><span class="k">default</span> <span class="mi">1</span> <span class="nx">worker</span><span class="o">*</span>
<span class="o">|</span>                   <span class="o">|</span>
<span class="o">|---</span> <span class="nx">Remote</span> <span class="nx">files</span> <span class="o">&lt;-|</span>     <span class="o">&lt;-|</span> <span class="nx">Filehandlers</span> <span class="nx">specified</span> <span class="nx">by</span> <span class="nx">the</span> <span class="nx">user</span>
<span class="o">|---</span> <span class="nx">Local</span> <span class="nx">files</span>  <span class="o">&lt;-|</span>       <span class="o">|</span> <span class="nx">transform</span> <span class="o">/</span> <span class="nx">handle</span> <span class="nx">uploaded</span> <span class="nx">files</span><span class="p">.</span> 
       <span class="p">(</span><span class="nx">http</span><span class="p">)</span>               <span class="o">|</span> <span class="nx">Eg</span><span class="p">.</span> <span class="nx">Uploading</span> <span class="nx">to</span> <span class="nx">remote</span> <span class="nx">services</span><span class="p">,</span>
                            <span class="o">|</span> <span class="nx">resizing</span> <span class="nx">images</span><span class="p">,</span> <span class="nx">converting</span> <span class="nx">sound</span><span class="p">,</span>
                            <span class="o">|</span> <span class="nx">video</span><span class="p">,</span> <span class="nx">generating</span> <span class="nx">tts</span> <span class="nx">or</span> <span class="nx">just</span> <span class="nx">making</span>
                            <span class="o">|</span> <span class="nx">cached</span> <span class="nx">versions</span> <span class="nx">of</span> <span class="nx">db</span> <span class="nx">files</span> <span class="nx">to</span> <span class="nx">the</span>
                            <span class="o">|</span> <span class="nx">filesystem</span><span class="p">.</span>
</pre></div>

<h2>How to use?</h2>

<h4>1. Install:</h4>

<pre><code>    mrt add collectionFS
</code></pre>

<p><em>Requires <code>Meteorite</code> get it at <a href="https://atmosphere.meteor.com">atmosphere.meteor.com</a></em></p>

<h4>2. Create model: [client, server]</h4>

<div class="highlight"><pre>    <span class="nx">ContactsFS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CollectionFS</span><span class="p">(</span><span class="s1">'contacts'</span><span class="p">);</span>
</pre></div>

<p><em>You can still create a <code>Contacts = new Meteor.Collection('contacts')</code> since gridFS maps on eg. <code>contacts.files</code> and <code>contacts.chunks</code></em></p>

<h4>3. Adding security in model: [client, server]</h4>

<p><em>Only needed when using <code>accounts-...</code> (eg. removed the <code>insecure</code> package)</em></p>

<div class="highlight"><pre>    <span class="nx">ContactsFS</span><span class="p">.</span><span class="nx">allow</span><span class="p">({</span>
      <span class="nx">insert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">myFile</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">userId</span> <span class="o">&amp;&amp;</span> <span class="nx">myFile</span><span class="p">.</span><span class="nx">owner</span> <span class="o">===</span> <span class="nx">userId</span><span class="p">;</span> <span class="p">},</span>
      <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="nx">modifier</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">myFile</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="p">(</span><span class="nx">userId</span> <span class="o">==</span> <span class="nx">myFile</span><span class="p">.</span><span class="nx">owner</span><span class="p">);</span>

        <span class="p">});</span>  <span class="c1">//EO interate through files</span>
      <span class="p">},</span>
      <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">files</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">});</span>
</pre></div>

<p><em>The collectionFS supports functions <code>.allow</code>, <code>.deny</code>, <code>.find</code>, <code>findOne</code> used when subscribing/ publishing from server</em> 
<em>It's here you can add restrictions eg. on content-types, filesizes etc.</em>
<em><code>.update</code>, <code>.remove</code> are also supported, <code>remove</code> removes all chunks and files related to the file removed</em></p>

<h4>4. Disabling autopublish:</h4>

<p><em>If you would rather not autopublish all files, you can turn off the autopublish option.  This is useful if you want to limit the number of published documents or the fields that get published</em></p>

<h5>Disabling autopublish: [client, server]</h5>

<div class="highlight"><pre>  <span class="nx">ContactsFS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CollectionFS</span><span class="p">(</span><span class="s1">'contacts'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">autopublish</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>
</pre></div>

<h5>Example [server]</h5>

<div class="highlight"><pre>    <span class="c1">// Disable autopublish</span>
    <span class="nx">ContactsFS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CollectionFS</span><span class="p">(</span><span class="s1">'contacts'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">autopublish</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>

    <span class="c1">// example #1 - manually publish with an optional param</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'listContactsFiles'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// sort by handedAt time and only return the filename, handledAt and _id fields</span>
      <span class="k">return</span> <span class="nx">ContactsFS</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">complete</span><span class="o">:</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">completed</span> <span class="p">},</span> <span class="p">{</span>
              <span class="nx">sort</span><span class="o">:</span><span class="p">{</span> <span class="nx">handledAt</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> 
              <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">filename</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">handledAt</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
              <span class="nx">limit</span><span class="o">:</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">limit</span>
      <span class="p">})</span>
    <span class="p">});</span>

    <span class="c1">// example #2 - limit results and only show users files they own</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'myContactsFiles'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">ContactsFS</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">owner</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">limit</span><span class="o">:</span> <span class="mi">30</span> <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>    
</pre></div>

<p><em>Note: It's possible to set one more option serverside: <code>ContactsFS = new CollectionFS('contacts', { maxFilehandlers: 1 });</code> - This will set max simultane filehandlers in total on the server, dispite collection</em></p>

<h5>Example [client]</h5>

<div class="highlight"><pre>    <span class="c1">// Disable autopublish / autosubscribe</span>
    <span class="nx">ContactsFS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CollectionFS</span><span class="p">(</span><span class="s1">'contacts'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">autopublish</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>

    <span class="c1">// example #1 - manually subscribe and show completed only </span>
    <span class="c1">// (goes with example #1 above)</span>

    <span class="c1">// Use session for setting filter options</span>
    <span class="nx">Session</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="s1">'myFilter'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">limit</span><span class="o">:</span> <span class="mi">30</span> <span class="p">});</span>

    <span class="c1">// Make subscription depend on the current filter</span>
    <span class="nx">Deps</span><span class="p">.</span><span class="nx">autorun</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">filter</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'myFilter'</span><span class="p">);</span>
      <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'listContactsFiles'</span><span class="p">,</span> <span class="nx">filter</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>

<h2>Uploading file</h2>

<h4>1. Adding the view:</h4>

<div class="highlight"><pre>    <span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"queControl"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Select file(s) to upload:<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"files"</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">class=</span><span class="s">"fileUploader"</span> <span class="na">multiple</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/template&gt;</span>
</pre></div>

<h4>2. Adding the controller: [client]</h4>

<div class="highlight"><pre>    <span class="nx">Template</span><span class="p">.</span><span class="nx">queControl</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
      <span class="s1">'change .fileUploader'</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">f</span><span class="p">;</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">ContactsFS</span><span class="p">.</span><span class="nx">storeFile</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>
</pre></div>

<p><em>ContactsFS.storeFile(f) returns fileId or null, actual downloads are spawned as "threads". It's possible to add metadata: <code>storeFile(file, {})</code> - callback or eventlisteners are on the todo</em></p>

<h2>Downloading file</h2>

<h4>1. Adding the view:</h4>

<div class="highlight"><pre>    <span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"fileTable"</span><span class="nt">&gt;</span>
      {{#each Files}}
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"btn btn-primary btn-mini btnFileSaveAs"</span><span class="nt">&gt;</span>Save as<span class="nt">&lt;/a&gt;</span>{{filename}}<span class="nt">&lt;br/&gt;</span>
      {{else}}
        No files uploaded
      {{/each}}
    <span class="nt">&lt;/template&gt;</span>
</pre></div>

<h4>2. Adding the controller: [client]</h4>

<div class="highlight"><pre>    <span class="nx">Template</span><span class="p">.</span><span class="nx">fileTable</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
      <span class="s1">'click .btnFileSaveAs'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ContactsFS</span><span class="p">.</span><span class="nx">retrieveBlob</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileItem</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">fileItem</span><span class="p">.</span><span class="nx">blob</span><span class="p">)</span>
            <span class="nx">saveAs</span><span class="p">(</span><span class="nx">fileItem</span><span class="p">.</span><span class="nx">blob</span><span class="p">,</span> <span class="nx">fileItem</span><span class="p">.</span><span class="nx">filename</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="nx">saveAs</span><span class="p">(</span><span class="nx">fileItem</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span> <span class="nx">fileItem</span><span class="p">.</span><span class="nx">filename</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="c1">//EO saveAs</span>
    <span class="p">});</span>
</pre></div>

<p><em>In future only a blob will be returned, this will return local file if available. The <code>Save as</code> calls the Filesaver.js by Eli Grey, <a href="http://eligrey.com">http://eligrey.com</a> - It doesn't work on iPad</em></p>

<h4>3. Adding controller helper: [client]</h4>

<div class="highlight"><pre>    <span class="nx">Template</span><span class="p">.</span><span class="nx">fileTable</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
      <span class="nx">Files</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">ContactsFS</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span> <span class="nx">sort</span><span class="o">:</span> <span class="p">{</span> <span class="nx">uploadDate</span><span class="o">:-</span><span class="mi">1</span> <span class="p">}</span> <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
</pre></div>

<p><em>There are some in the works for <code>widgets</code> / <code>components</code> eg. gui elements for uploading files, ex. via drag &amp; drop</em></p>

<h3>Create server cache/versions of files and get an url reference</h3>

<p>Filehandlers are serverside functions that makes caching versions easier. The functions are run and handled a file record and a blob / <code>Buffer</code> containing all the bytes.</p>

<ul>
<li>Return a blob and it gets named, saved and put in database while the user can continue. When files are created the files are updated containing link to the new file - all done reactivly live.</li>
<li>If only custom metadata is returned without a blob / Buffer then no files saved but metadata is saved in database.</li>
<li>If null returned then only filehandler name and a date is saved in database.</li>
<li>If false returned the filehandler failed and it will be resumed later</li>
</ul><h4>Options</h4>

<p><em>Each filehandler is handed a options object</em></p>

<div class="highlight"><pre><span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">blob</span><span class="p">,</span>              <span class="c1">// Type of node.js Buffer() </span>
  <span class="nx">fileRecord</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">chunkSize</span> <span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">,</span> <span class="c1">// Default 256kb ~ 262.144 bytes</span>
    <span class="nx">uploadDate</span> <span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>  <span class="c1">// Client set date</span>
    <span class="nx">handledAt</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>          <span class="c1">// datetime set by Server when handled</span>
    <span class="nx">fileHandler</span><span class="o">:</span><span class="p">{},</span>           <span class="c1">// fileHandler supplied data if any</span>
    <span class="nx">md5</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>               <span class="c1">// Not yet implemented</span>
    <span class="nx">complete</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>         <span class="c1">// countChunks == numChunks</span>
    <span class="nx">currentChunk</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>         <span class="c1">// Used to coordinate clients</span>
    <span class="nx">owner</span><span class="o">:</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">(),</span>
    <span class="nx">countChunks</span><span class="o">:</span> <span class="nx">countChunks</span><span class="p">,</span> <span class="c1">// Expected number of chunks</span>
    <span class="nx">numChunks</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>             <span class="c1">// number of chunks in database</span>
    <span class="nx">filename</span> <span class="o">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>     <span class="c1">// Original filename</span>
    <span class="nx">length</span><span class="o">:</span> <span class="s1">''</span><span class="o">+</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>     <span class="c1">// Issue in Meteor</span>
    <span class="nx">contentType</span> <span class="o">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
    <span class="nx">metadata</span> <span class="o">:</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>  <span class="c1">// Custom data</span>
    <span class="cm">/* TODO:</span>
<span class="cm">    startedAt: null,          // Start timer for upload start</span>
<span class="cm">    endedAt: null,            // Stop timer for upload ended</span>
<span class="cm">    */</span>
  <span class="p">},</span>
  <span class="nx">destination</span><span class="o">:</span> <span class="kd">function</span><span class="p">,</span> <span class="c1">// Check below</span>
  <span class="nx">sumFailes</span><span class="o">:</span> <span class="mi">0</span><span class="p">..</span><span class="mi">3</span> <span class="p">(</span><span class="nx">times</span> <span class="nx">filehandler</span> <span class="nx">failed</span> <span class="k">in</span> <span class="k">this</span> <span class="nx">recovery</span> <span class="nx">session</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

<h4>options.destination - function</h4>

<p><em>filehandlers are presented with a helper function for handling paths - all paths can be custom, but it's recommended to use those returned by <code>destination()</code></em>
<code>options.destination( [extension] )</code> takes an optional <code>extension</code> eg.:</p>

<div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">dest</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">destination</span><span class="p">(</span><span class="s1">'jpg'</span><span class="p">);</span> <span class="c1">// otherwise orginal extension is used</span>
</pre></div>

<p>Object returned:</p>

<div class="highlight"><pre>  <span class="nx">dest</span> <span class="o">==</span> <span class="p">{</span>
    <span class="nx">serverFilename</span><span class="o">:</span> <span class="s1">'/absolute/path/uniqname.jpg'</span><span class="p">,</span> <span class="c1">// Unix or windows based</span>
    <span class="nx">fileData</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">url</span><span class="o">:</span> <span class="s1">'/web/url/uniqname.jpg'</span><span class="p">,</span>
      <span class="nx">extension</span><span class="o">:</span> <span class="s1">'jpg'</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>

<p>The <code>destination</code> helper gets handy eg. when manually saving an image from within the filehandler.</p>

<div class="highlight"><pre>  <span class="nx">Filesystem</span><span class="p">.</span><span class="nx">fileHandlers</span><span class="p">({</span>
    <span class="nx">soundToWav</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Manipulate file, convert it to wav</span>
      <span class="kd">var</span> <span class="nx">dest</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">destination</span><span class="p">(</span><span class="s1">'wav'</span><span class="p">);</span>
      <span class="nx">writeFileToDisk</span><span class="p">(</span><span class="nx">dest</span><span class="p">.</span><span class="nx">serverFilename</span><span class="p">,</span> <span class="nx">blob</span><span class="p">);</span>

      <span class="c1">// Save correct reference to database by returning url and extension - but no blob</span>
      <span class="k">return</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">fileData</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
</pre></div>

<p>More examples follows, converters are to come:</p>

<div class="highlight"><pre><span class="nx">Filesystem</span><span class="p">.</span><span class="nx">fileHandlers</span><span class="p">({</span>
  <span class="nx">default1</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//Options contains blob and fileRecord - same is expected in return if should be saved on filesytem, can be modified</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'I am handling 1: '</span><span class="o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">fileRecord</span><span class="p">.</span><span class="nx">filename</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span> <span class="nx">blob</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">blob</span><span class="p">,</span> <span class="nx">fileRecord</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fileRecord</span> <span class="p">};</span> <span class="c1">//if no blob then save result in fileHandle (added createdAt)</span>
  <span class="p">},</span>
  <span class="nx">default2</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">fileRecord</span><span class="p">.</span><span class="nx">len</span> <span class="o">&gt;</span> <span class="mi">5000000</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fileRecord</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">!=</span> <span class="s1">'image/jpeg'</span><span class="p">)</span> <span class="c1">//Save som space, only make cache if less than 1Mb</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">//Not an error as if returning false, false would be tried again later...</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'I am handling 2: '</span><span class="o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">fileRecord</span><span class="p">.</span><span class="nx">filename</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">options</span><span class="p">;</span> 
  <span class="p">},</span>
  <span class="nx">size40x40</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="c1">// Use Future.wrap for handling async</span>
    <span class="cm">/*var im = npm.require('imagemagick'); // Add imagemagick package</span>
<span class="cm">    im.resize({</span>
<span class="cm">                srcData: options.blob,</span>
<span class="cm">                width: 40</span>
<span class="cm">           });*/</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'I am handling: '</span><span class="o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">fileRecord</span><span class="p">.</span><span class="nx">filename</span><span class="o">+</span><span class="s1">' to...'</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span> <span class="nx">extension</span><span class="o">:</span> <span class="s1">'jpg'</span><span class="p">,</span> <span class="nx">blob</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">blob</span><span class="p">,</span> <span class="nx">fileRecord</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fileRecord</span> <span class="p">};</span> <span class="c1">//or just 'options'...</span>
  <span class="p">},</span>
  <span class="nx">size100x100gm</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">fileRecord</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">!=</span> <span class="s1">'image/jpeg'</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// jpeg files only  </span>

    <span class="c1">// Use Future.wrap for handling async</span>
    <span class="cm">/*</span>
<span class="cm">    var dest = options.destination('jpg').serverFilename; // Set optional extension</span>

<span class="cm">    var gm = npm.require('gm'); // GraphicsMagick required need Meteor package</span>
<span class="cm">    gm( options.blob, dest).resize(100,100).quality(90).write(dest, function(err) {</span>
<span class="cm">        if(err) {</span>
<span class="cm">          // console.log 'GraphicsMagick error ' + err;</span>
<span class="cm">          return false; </span>
<span class="cm">          // False will trigger rerun, could check options.sumFailes</span>
<span class="cm">          // if we only want to rerun 2 times (default limit is 3,</span>
<span class="cm">          // but sumFailes is reset at server idle + wait period)</span>
<span class="cm">        }</span>
<span class="cm">        else {</span>
<span class="cm">          // console.log 'Finished writing image.';</span>
<span class="cm">          return destination('jpg').fileData; // We only return the url for the file, no blob to save since we took care of it</span>
<span class="cm">        }</span>
<span class="cm">      });</span>
<span class="cm">    */</span>
    <span class="c1">// I failed to deliver a url for this, but don't try again</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p><em>This is brand new on the testbed, future brings easy image handling shortcuts to imagemagic, maybe som sound/video converting and some integration for uploading to eg. google drive, dropbox etc.</em></p>

<h3>Future:</h3>

<ul>
<li>Handlebar helpers? <code>{{fileProgress}}</code>, <code>{{fileInQue}}</code> etc.</li>
<li>Test server side handling image size etc.</li>
<li>When code hot deploy the que halts, could be tackled in future version of Meteor</li>
<li>Deviates from gridFS by using string based files.length (Meteor are working on this issue)</li>
<li>Prepare ability for special version caching options creating converting images, docs, tts, sound, video, remote server upload etc.</li>
<li>Make Meteor packages for <code>GraphicsMagick</code> etc.</li>
</ul><h3>Notes:</h3>

<ul>
<li>This is made as <code>Make it work, make it fast</code>, well it just got very fast! <em>need to test if it's actually faster than regular upload</em>
</li>
<li>No test suite - any good ones for Meteor?</li>
<li>Current code client side contains relics and will have a makeover one of these days</li>
</ul>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>